<div class='pg-wrapper'>
  <div class='left-panel' *ngIf="records.length > 0">
    <div class="flex" style="justify-content: space-around; margin-top: 8px;">
      <h4 style="margin: 10px; text-align:center;" *ngIf="records.length > 0 && !retrievingSources">
        {{(currentRecordIndex + 1) + (recordsPerPage * page.number) | number }} / {{totalStoreSourceRecords | number}}
      </h4>
      <h4 style="margin: 10px; text-align:center;" *ngIf="records.length > 0 && retrievingSources">
        <i class="fas fa-spinner fa-spin"></i> / {{totalStoreSourceRecords | number}}
      </h4>
    </div>
    <div *ngIf="records.length > 0" style="padding: 0 15px;">
      <mat-form-field>
          <mat-select placeholder="Records Per Page" (selectionChange)="getSources()" [(value)]="recordsPerPage">
              <mat-option *ngFor="let o of sizeOptions" [value]="o">{{o}}</mat-option>
            </mat-select>
      </mat-form-field>
      
    </div>
    <div class="flex-between" *ngIf="page && page.totalPages > 1">
        <button title="Previous Page" [disabled]="page.first" (click)="prevPage()"><i class="fas fa-step-backward"></i></button>
        <button title="Go To Next Unvalidated Record" (click)="getSources()"><i class="far fa-check-circle"></i></button>
        <button title="Next Page" [disabled]="page.last" (click)="nextPage()"><i class="fas fa-step-forward"></i></button>
    </div>
    <mat-list>
      <mat-list-item [id]="i" *ngFor="let record of records; let i = index" [ngClass]="{highlighted: i === currentRecordIndex, muted: record.validatedDate}"
                     (click)="setCurrentRecord(i)">
        <div>
          <span class='list-item-header' id="ssn" *ngIf="record.sourceStoreName">{{record.sourceStoreName}}</span>
          <br>
           
            <span class="list-item-desc" *ngIf="record.validatedDate">Validated: {{record.validatedDate | date}}</span>
            <span class="list-item-desc" *ngIf="!record.validatedDate">Not Validated</span>
          
        </div>
      </mat-list-item>
    </mat-list>
    <div class="flex-between" *ngIf="page && page.totalPages > 1">
        <button title="Previous Page" [disabled]="page.first" (click)="prevPage()"><i class="fas fa-step-backward"></i></button>
        <button title="Go To Next Unvalidated Record" (click)="getSources()"><i class="far fa-check-circle"></i></button>
        <button title="Next Page" [disabled]="page.last" (click)="nextPage()"><i class="fas fa-step-forward"></i></button>
    </div>
  </div>
  <div class="center-panel hidden-sm">
    <mds-map #pgMap class="row content" (ready)="onMapReady($event)"></mds-map>
  </div>
  <div class="right-panel">
    <div class='loader' *ngIf="isFetching">
      <div>
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <br>
        <div class='large-text'>
          Fetching Data
        </div>
      </div>
    </div>
    <mat-horizontal-stepper [linear]='true' #stepper style="padding-bottom: 50px;">
      <ng-template matStepperIcon="edit">
        <i class="fas fa-pencil-alt"></i>
      </ng-template>
      <ng-template matStepperIcon="done">
        <i class="fas fa-check"></i>
      </ng-template>
      <mat-step editable="false">
        <ng-template matStepLabel>Match Site</ng-template>
        <div class='flex-container' *ngIf="chainXyRecord">
          <div>
            <div class='large-text'>
              
                {{chainXyRecord.StoreName}}
              
            </div>
            <div class='med-text'> {{chainXyRecord.Address + ", "
              + chainXyRecord.City + ","+
              chainXyRecord.State}}
            </div>
            <div class='small-text'>
              Closed: {{chainXyRecord.Closed}}
            </div>
          </div>
          <button (click)="noMatch()" mat-button class=''>Add Site
          </button>
        </div>
        <div class='accent-bar large-text'>Match to Existing</div>
        <div class='results-table'>

          <div class='loader' *ngIf="gettingEntities">
            <div>
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              <br>
              <div class='large-text'>
                Fetching Stores From MTNRA Database
              </div>
            </div>
          </div>
          <div [ngClass]="i % 2 != 0 ? 'results-item secondary-row':'results-item'"
               *ngFor="let site of currentDBResults; let i=index;">
            <div class="results-header large-text flex-container">


              <i mat-icon-button [mat-menu-trigger-for]="siteMenu" class="site-menu fas fa-ellipsis-v"></i>

              <mat-menu #siteMenu="matMenu">
                <button (click)="matchShoppingCenter(site.shoppingCenterId);"
                        mat-menu-item>Add Sister Shopping Center Site
                </button>
              </mat-menu>

              <div *ngIf="site.distanceFrom" [style.color]="site.distanceFrom < 0.5 ? 'green': '#ff9802'"
                   class='site-distance'>
                <i class="fas fa-arrow-circle-up" [style.transform]="site.heading"></i> {{site.distanceFrom.toFixed(2)}}
                Miles
              </div>
              <div class='site-title'>{{site.address1 + ", " + site.city + ", " + site.state }}</div>
              <button (click)="matchSite(site.id)" mat-button
                      class=' add-store'>Add Store
              </button>
            </div>
            <mat-divider></mat-divider>
            <div (mouseenter)="siteHover(store, 'enter')" (mouseleave)="siteHover(store, 'leave')" class="results-each"
                 *ngFor="let store of site.stores">
              <div class="flex-container">
                <div class='store-attribute'>{{store.storeName}}</div>
                <div class='hidden-xs store-attribute'>{{store.storeType}}</div>
                <div class='hidden-xs store-attribute'>{{store.currentStoreStatus}}</div>
                <button (click)="matchStore(store.id)" mat-button matStepperNext
                        [ngClass]="{'highlighted': bestMatch && bestMatch.store.id == store.id && bestMatch.score <=4}">
                  Match
                </button>
              </div>
            </div>
          </div>

        </div>
        <!-- </form> -->
      </mat-step>
      <mat-step>
        <ng-template matStepLabel>Match/Edit Data</ng-template>
        <mds-chain-xy-data-form *ngIf="sourceUpdatable" [chainXyUpdatable]="sourceUpdatable"
                          [chainXyFeature]="chainXyRecord"
                          [storeSource]="currentStoreSource"
                          (cancelEvent)="cancelStep2()"
                          (completedEvent)="nextRecord()">
        </mds-chain-xy-data-form>
      </mat-step>
    </mat-horizontal-stepper>
  </div>
</div>
